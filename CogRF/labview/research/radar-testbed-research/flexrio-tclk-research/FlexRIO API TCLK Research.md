# FlexRIO API TCLK Research

[[_TOC_]]

## Examples
### Default TCLK Example
- This example is located in the shipping examples for Integrated IO Devices
    - Open LabVIEW 
    - Select Example Finder 
    - Search "Integrated IO" or the model number of the device of interest
    - Select "Getting Started FlexRIO
    - Once the project is generated, there will be examples showing synchronized acquistion, generation, or both depending on the modules capabilities

### FlexRIO Team's Test Code for TCLK 
- Perforce: //Measurements/FlexRIO/SWCode/MacallanATS/trunk/17.1/source/tests/TclkDefault/

### FlexRIO Team's Test Code for Multichassis TCLK
- Perforce: //Measurements/FlexRIO/SWCode/MacallanATS/trunk/17.1/source/tests/TclkMultichassis/

### FlexRIO Team's Test Code for Multi Controller TCLK
- This code treats modules in the same chassis as if they are in a Server Controller and Client Controller. In order to make this example work with two seperate controllers, a communication scheme will need to be added and functionality seperated. 
- Perforce: //Measurements/FlexRIO/SWCode/MacallanATS/trunk/17.1/source/tests/TclkMulticontroller/

### TClk with Manual Adjustments
- This code was written for a customer example in a pinch by Brad Sherman and David Randolph
- Perforce: //Sales/users/BradSherman/FlexRIO 5764 Multi Chassis and Streaming Example/
    

## TI Clocking Chip Bug

### Thoughts from Pedro Rivera
Pedro designed the FPGA firmware for the 5785 and did the synchronization specification setting. The data sheet lits: (1) Skew = 80 ps, and (2) Skew after manual adjustment <= 10 ps. 

Here are Pedro's thoughts:

"Spec (1) is the worst-case skew we observed after doing an 'out-of-the-box' synchronization. That is, you take N modules out of the box, feed them a signal through length matched cables, and “click synchronize”. This measurement does not calibrate out system offset from the measurement. System offset in this context is the lumped delay variations of every module due to process variation, length mismatch, and such."

"Spec (2) is the achievable skew once you calibrate out the system offset and set each module’s phase DAC to a fixed value, which you clearly are aware of."

"Late in the development of this product we found a quirk in the TI clocking distribution chip it uses. From configuration to configuration the chip will inexplicably vary the phase of its clock outputs by +/-5 ps. We worked extensively with TI for weeks to find a cause and workaround, and it seems like we know the likely cause, but couldn’t find a workaround. The case is still open, and I have documented it in the following file: https://nio365-my.sharepoint.com/:w:/g/personal/pedro_rivera_ni_com/EWMtSpMVzA5Aqrq75nqKkVEB6W0wc3jmNACFKmJ6H9XkLQ?e=QAIvbc"


### Test Results from David Toth, Principal AE
Measurement Setup: 1095 chassis with two PXIe-5785 (KU060, with AO filter, PN 146636A-06L) in slots 2 and 3, and a PXIe-5186 to acquire the signals generated by the 5785s. Both 5785s are generating the same CW signal on both channels (AO0 and AO1), so this is a 3.2GSPS generation, and the 5186 is connected to two AO channels and measures the phase difference between the two channels. 

Using the phase difference (and the CW frequency) the skew between the channels is calculated. This measurement is repeated multiple times to produce a histogram of the channel to channel skew variation, with the 5785s opened/synchronized/closed in every iteration.Results depict results from run-to-run, not the absolute skew between the channels. 

When measuring the skew variation between AO0 and AO1 of a single 5785 after 300 measuremnts. The variation is +/-150 fs.

![](./Images/SkewResults_Ao0_Ao1_Single5785.png)

Skew reults from AO0 between two 5785 and 3000 measurements using TCLK. There is a +/-10 ps spread which is within the 80 ps specified in the Specifications Document. 

![](./Images/SkewResults_Ao0_Dual5785.png)

After setting the Phase Dac value constant to remove the TDC Jitter, there are distinct buckets of delays that result from the bug in the TI Chip.

![](./Images/SkewResults_Ao0_Dual5785_PhaseDAC.png)

### Devices that use the LMK04832 Chip
https://echo.natinst.com/echo/part/whereused/156617235/258147376
- CCA,NI-65XX, CERBERUS (HALF IN/OUT)
- CCA,NI-65XX, CERBERUS (ALL IN)
- CCA,NI-65XX, CERBERUS (ALL OUT)
- CA,NI-65XX, CERBERUS (HALF IN/OUT)
- CCA,PXIE-XXXX ROSSO LITE (GEN 3)
- CCA,JACKALOPE IF TRANSCEIVER FAM
- CCA,JACKALOPE IF DIGITIZER FAM
- CCA,JACKALOPE IF SIGNAL GENERATOR FAM
- CCA,NI-5785,JACKALOPE,IF TRANSCEIVER
- CCA,NI-5775,JACKALOPE,IF DIGITIZER
- CCA,NI-5745,JACKALOPE,IF SIGNAL GENERATOR
- CCA,NI-5785,JACKALOPE,IF TRANSCEIVER, W/ AO FLTR
- CCA,NI-5745,JACKALOPE,IF SIGNAL GENERATOR, W/ AO FLTR
- CCA,NI-5785,JACKALOPE,IF TRANSCEIVER
- CCA,NI-5775,JACKALOPE,IF DIGITIZER
- CCA,NI-5745,JACKALOPE,IF SIGNAL GENERATOR
- CCA,NI-5785,JACKALOPE,IF TRANSCEIVER, W/ AO FLTR
- CCA,NI-5745,JACKALOPE,IF SIGNAL GENERATOR, W/ AO FLTR
- CCA,SPHINX
- CCA, NI-5774, SPHINX, 3 GHZ
- CCA, NI-5774, SPHINX, 1.6 GHZ
- CCA, NI-5774, SPHINX, 3 GHZ
- CCA, NI-5774, SPHINX, 1.6 GHZ
- CCA, NI-5774, SPHINX, 3 GHZ
- CCA, NI-5774, SPHINX, 1.6 GHZ
- CCA, NI-5774, SPHINX, 3 GHZ
- CCA, NI-5774, SPHINX, 1.6 GHZ
- CCA,USRP X400,TITANIUM BASECARD
- CCA,USRP X400,TITANIUM BASECARD
- CCA,USRP X410,BASECARD
- CCA,PXIE-XXXX ROSSO SIGNAL CONDITIONING PCB
- CCA,PXIE-XXXX ROSSO SIGNAL CONDITIONING PCB - GEN 3 PROTOTYPE
- TEST FIXTURE ASSY,CBA3 BREAKOUT FIXTURE
- TEST FIXTURE ASSY,CBA3 BREAKOUT FIXTURE
- PROTOTYPE ASSY,KRAKKEN


